# RETROMATION_EXPORT_GUIDE.md

## Overview
This guide explains how to convert show data generated by the [Cyberstar Analog Signal Simulator](https://github.com/Jakeagle/Cyberstar-Analog-Signal-Simulator) into a file format compatible with **RetroMation**, the animatronic simulator game that uses `.rshw` / `.shw` showtape files.

The process converts your simulated Biphase Mark Code (BMC) control data and synchronized audio into a **multi-channel WAV** (L, R, TD, BD), then packages it into an `.rshw` show file using community tools like **Transmutate**.

---

## Contents
1. [RetroMation File Format Overview](#retromation-file-format-overview)
2. [Export Requirements](#export-requirements)
3. [Audio & Data Channel Layout](#audio--data-channel-layout)
4. [Generating Show Data in the Simulator](#generating-show-data-in-the-simulator)
5. [Exporting a Multi-Channel WAV](#exporting-a-multi-channel-wav)
6. [Converting to .rshw Format](#converting-to-rshw-format)
7. [References & Resources](#references--resources)

---

## RetroMation File Format Overview

RetroMation showtapes are multi-track audio containers that include:

| Channel | Description | Notes |
|----------|--------------|-------|
| 1 | Music Left (L) | Stereo program audio |
| 2 | Music Right (R) | Stereo program audio |
| 3 | Treble Data (TD) | Biphase-encoded animatronic control signal |
| 4 | Bass Data (BD) | Biphase-encoded animatronic control signal |

Each control data channel carries serial data encoded using **Biphase Mark Code (BMC)** at 4800 baud. The playback engine reads these to animate the show’s characters.

---

## Export Requirements

| Parameter | Recommended Value | Reason |
|------------|------------------|--------|
| Sample Rate | **48,000 Hz** | 48k divides evenly by 4800 baud (10 samples per bit) |
| Bit Depth | **16-bit PCM** | RetroMation-compatible standard |
| Channels | **4 (L, R, TD, BD)** | Matches RetroMation’s layout |
| Duration | Must match total show length | All channels aligned |

Use the same timing base for all channels. Ensure your Cyberstar waveform generation uses 48 kHz for perfect biphase decoding.

---

## Audio & Data Channel Layout

```
+----------------------------------------------------------+
| Channel 1 | Channel 2 | Channel 3 | Channel 4           |
|------------|------------|------------|--------------------|
| Music L    | Music R    | TD (BMC)   | BD (BMC)           |
+----------------------------------------------------------+
```

- **Music L/R:** Stereo mix of the show soundtrack.
- **TD/BD:** PCM waveform representing your BMC data for Treble and Bass drivers.

---

## Generating Show Data in the Simulator

Your repository already creates the BMC data streams within `CyberstarSignalGenerator`.
To export those signals offline:

1. Collect complete BMC waveforms for both Treble and Bass data channels.
   - The generator’s `_scheduleFrame()` and `generateBMCWaveform()` already output these per-frame.
   - Concatenate the generated buffers across the show timeline.
2. Store these in memory as two `Float32Array` buffers: `tdWaveform`, `bdWaveform`.
3. Combine with your music stereo buffers (`musicL`, `musicR`).

---

## Exporting a Multi-Channel WAV

The following Node.js utility creates a **4-channel 48 kHz WAV** from your Float32 buffers.

Save this as `export_rshw_wav.js`:

```js
const fs = require('fs');

function encode4chWav(channels, sampleRate = 48000) {
  const numChannels = channels.length;
  const len = channels[0].length;
  const blockAlign = numChannels * 2;
  const byteRate = sampleRate * blockAlign;
  const dataSize = len * blockAlign;
  const header = Buffer.alloc(44);

  header.write('RIFF', 0);
  header.writeUInt32LE(36 + dataSize, 4);
  header.write('WAVE', 8);
  header.write('fmt ', 12);
  header.writeUInt32LE(16, 16);
  header.writeUInt16LE(1, 20);
  header.writeUInt16LE(numChannels, 22);
  header.writeUInt32LE(sampleRate, 24);
  header.writeUInt32LE(byteRate, 28);
  header.writeUInt16LE(blockAlign, 32);
  header.writeUInt16LE(16, 34);
  header.write('data', 36);
  header.writeUInt32LE(dataSize, 40);

  const interleaved = Buffer.alloc(dataSize);
  let offset = 0;
  for (let i = 0; i < len; i++) {
    for (let ch = 0; ch < numChannels; ch++) {
      const s = Math.max(-1, Math.min(1, channels[ch][i]));
      interleaved.writeInt16LE(Math.floor(s * 0x7fff), offset);
      offset += 2;
    }
  }

  return Buffer.concat([header, interleaved]);
}

function exportShow(outPath, musicL, musicR, td, bd) {
  const wav = encode4chWav([musicL, musicR, td, bd]);
  fs.writeFileSync(outPath, wav);
  console.log('Exported:', outPath);
}

module.exports = { exportShow };
```

Example usage:

```bash
node export_rshw_wav.js
```

This creates `output_4ch.wav` — a RetroMation-ready file.

---

## Converting to .rshw Format

### Option 1: Use Transmutate

The community-built **Transmutate** tool converts WAV or legacy `.shw` files into `.rshw` format.

1. Download Transmutate:
   - [Transmutate GitHub Repository](https://github.com/RR-Engine/Transmutate)
2. Place your `output_4ch.wav` in the same folder.
3. Drag and drop it onto `transmutate.exe`, or run in terminal:
   ```bash
   transmutate output_4ch.wav
   ```
4. The tool produces `output_4ch.rshw`, ready for RetroMation.

### Option 2: ffmpeg (Audio Only)

If you just need a clean multichannel WAV:

```bash
ffmpeg -i output_4ch.wav -ar 48000 -ac 4 -c:a pcm_s16le show_ready.wav
```

---

## Validation in RetroMation

1. Launch RetroMation.
2. Navigate to the showtape import directory (commonly `/Shows/` or `/Import/`).
3. Place the `.rshw` file inside.
4. Open RetroMation’s interface, select your show, and verify all audio and animation data sync correctly.

---

## References & Resources

- **RetroMation Wiki:** [https://retromation.fandom.com/](https://retromation.fandom.com/)
- **Transmutate Tool:** [https://github.com/RR-Engine/Transmutate](https://github.com/RR-Engine/Transmutate)
- **Rock-afire Explosion Data Format:** [https://rockafireexplosion.com](https://rockafireexplosion.com)
- **Biphase Mark Code (BMC) Overview:** [https://en.wikipedia.org/wiki/Biphase_mark_code](https://en.wikipedia.org/wiki/Biphase_mark_code)
- **Cyberstar Data Systems Info (Archived):** [https://showbizpizza.com/raetech/cyberstar.html](https://showbizpizza.com/raetech/cyberstar.html)

---

## Notes
- Keep amplitude of control channels within ±0.8 to prevent clipping.
- Always align the duration of all channels.
- For automated builds, integrate this export process into your show compilation script.
- You can automate Transmutate conversions by calling it via `child_process` in Node.

---

### Example End-to-End Summary
1. Run your simulator to produce full show TD/BD BMC arrays.
2. Merge with stereo music.
3. Encode into `output_4ch.wav` (48 kHz, 16-bit).
4. Convert using Transmutate → `output_4ch.rshw`.
5. Import into RetroMation and test.

Congratulations — your simulated Cyberstar showtape is now playable in RetroMation!

